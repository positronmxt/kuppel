name: Geodesic Dome CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run unit tests
        run: |
          python -m pytest tests/test_geometry.py -v --tb=short

  integration-tests:
    name: Integration Tests (FreeCAD)
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install FreeCAD AppImage
        run: |
          wget -q https://github.com/FreeCAD/FreeCAD/releases/download/1.0.0/FreeCAD_1.0.0-conda-Linux-x86_64.AppImage -O freecad.AppImage
          chmod +x freecad.AppImage
          # Extract AppImage for headless use
          ./freecad.AppImage --appimage-extract > /dev/null 2>&1
          echo "$PWD/squashfs-root/usr/bin" >> $GITHUB_PATH

      - name: Install test dependencies
        run: |
          pip install pytest
          # ifcopenshell for IFC validation tests
          pip install ifcopenshell || echo "ifcopenshell not available, IFC tests will be skipped"

      - name: Run integration tests
        run: |
          python -m pytest tests/test_integration.py -v --tb=short

  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install tools
        run: |
          pip install ruff

      - name: Run linter
        run: |
          ruff check freecad_dome/ tests/ scripts/
